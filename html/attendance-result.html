<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Attendance Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
  <style>
    body {
      background-color: #f4f7fa;
    }
    .navbar {
      background-color: #007bff;
    }
    .navbar-brand {
      color: white;
    }
    .card {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border: none;
    }
    .btn-search {
      margin-top: 10px;
    }
    .btn-success {
      margin-top: 20px;
    }
    .student-row {
      background-color: #e9ecef;
      font-weight: bold;
    }
    .attendance-date {
      font-style: italic;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Attendance System</a>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row">
      <div class="col-md-8 mx-auto">
        <div class="card p-4">
          <h3 class="text-center">Attendance Results</h3>

          <div class="input-group mb-3">
            <input type="text" id="searchRollNo" class="form-control" placeholder="Search by Roll No" aria-label="Search by Roll No" aria-describedby="searchButton">
            <button class="btn btn-outline-primary" type="button" id="searchButton" onclick="searchByRollNo()">Search</button>
          </div>

          <div class="input-group mb-3">
            <label class="input-group-text" for="specificDate">Select Date: </label>
            <input type="date" id="specificDate" class="form-control" onchange="filterByDate()">
          </div>

          <table class="table table-bordered mt-4" id="attendanceTable">
            <thead>
              <tr>
                <th>Roll No</th>
                <th>Name</th>
                <th>Attendance Dates & Status</th>
              </tr>
            </thead>
            <tbody id="attendanceResultsContainer">
              <!-- Attendance data will be inserted here -->
            </tbody>
          </table>

          <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let originalData = [];

    // Function to parse query parameters
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        branch: params.get('branch'),
        year: params.get('year'),
        division: params.get('division'),
        month: params.get('month')
      };
    }

    // Fetch attendance data based on query params
    function fetchAttendanceData() {
      const { branch, year, division, month } = getQueryParams();

      const url = `http://localhost:5000/attendance/${branch}/${year}/${division}?month=${month}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          originalData = data; // Store original data for filtering
          groupAndDisplayData(data); // Group data by student and display
        })
        .catch(error => {
          console.error('Error fetching attendance:', error);
        });
    }

    // Group attendance by student and populate table
    function groupAndDisplayData(data) {
      const container = document.getElementById('attendanceResultsContainer');
      container.innerHTML = ''; // Clear previous content

      if (data.length === 0) {
        container.innerHTML = '<tr><td colspan="3" class="text-center text-danger">No attendance records found for this month.</td></tr>';
        return;
      }

      // Group data by student (rollNo)
      const groupedData = data.reduce((acc, record) => {
        if (!acc[record.rollNo]) {
          acc[record.rollNo] = {
            name: record.name,
            attendance: []
          };
        }
        acc[record.rollNo].attendance.push({
          date: new Date(record.date).toLocaleDateString(),
          status: record.attendanceStatus
        });
        return acc;
      }, {});

      // Display grouped data
      Object.keys(groupedData).forEach(rollNo => {
        const student = groupedData[rollNo];
        const row = document.createElement('tr');
        row.classList.add('student-row');
        row.innerHTML = `
          <td>${rollNo}</td>
          <td>${student.name}</td>
          <td>
            <ul>
              ${student.attendance.map(a => `<li class="attendance-date">${a.date}: ${a.status}</li>`).join('')}
            </ul>
          </td>
        `;
        container.appendChild(row);
      });
    }

    // Search by Roll No
    function searchByRollNo() {
      const searchValue = document.getElementById('searchRollNo').value.toLowerCase();
      const filteredData = originalData.filter(record => record.rollNo.toLowerCase().includes(searchValue));
      groupAndDisplayData(filteredData);
    }

    // Filter by specific date
    function filterByDate() {
      const selectedDate = new Date(document.getElementById('specificDate').value);
      if (!selectedDate) return;

      const filteredData = originalData.filter(record => new Date(record.date).toLocaleDateString() === selectedDate.toLocaleDateString());
      groupAndDisplayData(filteredData);
    }

    // Export table data to Excel
    function exportToExcel() {
      const table = document.querySelector('table');
      const wb = XLSX.utils.table_to_book(table, { sheet: "Attendance Data" });
      XLSX.writeFile(wb, 'AttendanceData.xlsx');
    }

    // Fetch data when the page loads
    document.addEventListener('DOMContentLoaded', fetchAttendanceData);
  </script>
</body>
</html>


































